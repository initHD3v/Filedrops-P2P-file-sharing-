(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();const i={myId:null,myNickname:"Loading...",users:[],theme:localStorage.getItem("theme")||"light",peerConnections:{},fileChannels:{},peerConnectionStates:{},transferStatus:"",transferProgress:0,isTransferring:!1,cancelTransfer:()=>{},incomingFileModal:{isOpen:!1,senderNickname:"",fileName:"",fileSize:"",thumbnail:null,onAccept:()=>{},onReject:()=>{}},toast:{isShown:!1,message:"",type:"info"}},v=new Set,m=()=>{for(const e of v)e()};function D(e){return v.add(e),e(),()=>v.delete(e)}function N(e,n){i.myId=e,i.myNickname=n,m()}function T(e){i.users=e.filter(n=>n.id!==i.myId),m()}function F(e,n){i.peerConnectionStates[e]=n,m()}function O(e){i.theme=e,localStorage.setItem("theme",e),document.documentElement.setAttribute("data-theme",e),m()}function p(e){Object.assign(i,e),m()}function z(){i.isTransferring=!1,i.transferProgress=0,m()}function A({senderNickname:e,fileName:n,fileSize:s,thumbnail:t,onAccept:o,onReject:a}){i.incomingFileModal={isOpen:!0,senderNickname:e,fileName:n,fileSize:s,thumbnail:t,onAccept:o,onReject:a},m()}function L(){i.incomingFileModal.isOpen=!1,m()}function y(e,n="info"){i.toast={isShown:!0,message:e,type:n},m(),setTimeout(()=>{i.toast.isShown=!1,m()},3e3)}const u=()=>i;function x(e,n){i.peerConnections[e]=n}function E(e){return i.peerConnections[e]}function U(e){if(i.peerConnections[e]){try{i.peerConnections[e].close()}catch(n){console.error("Error closing peer connection:",n)}delete i.peerConnections[e]}}function M(e,n){i.fileChannels[e]=n}function j(e){return i.fileChannels[e]}function H(e){if(i.fileChannels[e]){try{i.fileChannels[e].close()}catch(n){console.error("Error closing file channel:",n)}delete i.fileChannels[e]}}function S(e){U(e),H(e)}const I=64*1024,B={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};let C={},k={},w={};async function P(e,n){const s=new RTCPeerConnection(B);if(x(e,s),s.onicecandidate=t=>{t.candidate&&b({type:"ice-candidate",targetId:e,candidate:t.candidate})},s.ondatachannel=t=>{console.log("Data channel received");const o=t.channel;M(e,o),$(o,e)},s.onconnectionstatechange=()=>{const t=s.connectionState;console.log(`Peer connection with ${e} changed to ${t}`),F(e,t),(t==="disconnected"||t==="failed"||t==="closed")&&S(e)},n){const t=s.createDataChannel("file-transfer");M(e,t),$(t,e);try{const o=await s.createOffer();await s.setLocalDescription(o),b({type:"offer",targetId:e,offer:o})}catch(o){console.error("Error creating offer:",o)}}}function $(e,n){e.binaryType="arraybuffer",e.onmessage=s=>W(s,n),e.onopen=()=>console.log(`Data channel with ${n} is open`),e.onclose=()=>{console.log(`Data channel with ${n} is closed`),S(n)}}function W(e,n){const s=e.data;try{const t=JSON.parse(s);if(t.type==="file-metadata"){k[n]=t,C[n]=[],w[n]={receivedSize:0},console.log(`Receiving file: ${t.name} (${t.size} bytes)`),p({isTransferring:!0,transferStatus:`Incoming file: ${t.name}`,transferProgress:0});return}}catch{const o=k[n];if(!o){console.error("Received file chunk without metadata.");return}C[n].push(s),w[n].receivedSize+=s.byteLength;const a=Math.round(w[n].receivedSize/o.size*100);if(p({transferProgress:a,transferStatus:`Downloading... ${a}%`}),w[n].receivedSize===o.size){const c=new Blob(C[n]),l=URL.createObjectURL(c),f=document.createElement("a");f.href=l,f.download=o.name,document.body.appendChild(f),f.click(),f.remove(),URL.revokeObjectURL(l),p({transferStatus:`File ${o.name} received successfully!`,isTransferring:!1}),y("File received!","success"),delete k[n],delete C[n],delete w[n]}}}async function J(e,n){const s=n[0],t=j(e);if(!t||t.readyState!=="open"){y("Connection not ready. Please wait.","error");return}const o={name:s.name,size:s.size,type:"file-metadata"};t.send(JSON.stringify(o)),p({isTransferring:!0,transferStatus:`Sending: ${s.name}`,transferProgress:0,cancelTransfer:()=>{console.log("Transfer cancelled"),z(),p({transferStatus:"Transfer cancelled."}),y("Transfer cancelled","error")}});let a=0;const c=new FileReader;c.onload=f=>{if(u().isTransferring)try{t.send(f.target.result),a+=f.target.result.byteLength;const g=Math.round(a/s.size*100);p({transferProgress:g,transferStatus:`Sending... ${g}%`}),a<s.size?l(a):(p({transferStatus:`File ${s.name} sent successfully!`,isTransferring:!1}),y("File sent!","success"))}catch(g){console.error("Error sending file chunk:",g),p({transferStatus:`Error: ${g.message}`,isTransferring:!1})}};const l=f=>{const g=s.slice(f,f+I);c.readAsArrayBuffer(g)};l(0)}async function _(e,n){try{await P(e,!1);const s=E(e);await s.setRemoteDescription(new RTCSessionDescription(n));const t=await s.createAnswer();await s.setLocalDescription(t),b({type:"answer",targetId:e,answer:t})}catch(s){console.error("Error handling offer:",s)}}async function q(e,n){try{await E(e).setRemoteDescription(new RTCSessionDescription(n))}catch(s){console.error("Error handling answer:",s)}}async function K(e,n){try{const s=E(e);s&&n&&await s.addIceCandidate(new RTCIceCandidate(n))}catch(s){console.error("Error handling ICE candidate:",s)}}let h;function R(){const n=`${window.location.protocol==="https"?"wss":"ws"}://${window.location.host}/ws`;h=new WebSocket(n),h.onopen=()=>{console.log("Connected to signaling server"),y("Connected to server","success")},h.onmessage=s=>{const t=JSON.parse(s.data),{myId:o}=u();if(!(t.targetId&&t.targetId!==o))switch(t.type){case"your-id":N(t.id,t.nickname);break;case"users":const{users:a}=t,c=new Set(u().users.map(d=>d.id)),l=new Set(a.map(d=>d.id));a.forEach(d=>{o<d.id&&(console.log(`My ID is smaller, initiating connection to ${d.nickname}`),P(d.id,!0))}),c.forEach(d=>{l.has(d)||(console.log(`User ${d} disconnected, cleaning up connections.`),S(d))}),T(a);break;case"offer":_(t.senderId,t.offer);break;case"answer":q(t.senderId,t.answer);break;case"ice-candidate":K(t.senderId,t.candidate);break;case"file-transfer-request":A({...t,onAccept:()=>{b({type:"accept-transfer",targetId:t.senderId}),L()},onReject:()=>{b({type:"reject-transfer",targetId:t.senderId}),L()}});break}},h.onclose=()=>{console.log("Disconnected from signaling server"),y("Disconnected from server. Trying to reconnect...","error"),u().users.forEach(s=>S(s.id)),T([]),setTimeout(R,3e3)},h.onerror=s=>{console.error("WebSocket error:",s),y("WebSocket connection error","error")}}function b(e){h&&h.readyState===WebSocket.OPEN&&h.send(JSON.stringify(e))}function V(e){N(u().myId,e),b({type:"nickname-update",nickname:e}),y("Nickname updated!","success")}const r={};function Z(){["my-nickname","user-list","no-users-message","transfer-progress-container","transfer-progress-bar","transfer-status","cancel-transfer-button","file-input","file-notification-modal","sender-nickname","thumbnail-container","incoming-file-name","incoming-file-size","reject-file-button","accept-file-button","theme-toggle","toast-container","developer-info","app-version"].forEach(n=>{r[n]=document.getElementById(n)}),r.modalInstance=new bootstrap.Modal(r["file-notification-modal"])}function G(){const e=u();r["my-nickname"].textContent=e.myNickname,r["theme-toggle"].checked=e.theme==="dark",document.documentElement.setAttribute("data-theme",e.theme),r["user-list"].innerHTML="",e.users.length===0?r["no-users-message"].style.display="block":(r["no-users-message"].style.display="none",e.users.forEach(t=>{const o=u().peerConnectionStates[t.id]||"new";let a="grey",c="user-card text-center p-3";switch(o){case"connected":a="green",c+=" clickable";break;case"connecting":case"new":a="grey";break;default:a="red";break}const l=document.createElement("div");l.className=`${c}`,l.innerHTML=`
          <span class="status-dot ${a}"></span>
          <i class="material-icons user-icon">person</i>
          <p class="user-nickname mt-2">${t.nickname}</p>
      `,o==="connected"&&l.addEventListener("click",()=>{r["file-input"].setAttribute("data-target-id",t.id),r["file-input"].click()}),r["user-list"].appendChild(l)}));const n=r["transfer-progress-container"];e.isTransferring?(n.style.display="block",r["transfer-progress-bar"].style.width=`${e.transferProgress}%`,r["transfer-progress-bar"].textContent=`${e.transferProgress}%`,r["transfer-status"].textContent=e.transferStatus,r["cancel-transfer-button"].style.display="block"):(n.style.display="none",r["cancel-transfer-button"].style.display="none",r["transfer-status"].textContent=e.transferStatus);const s=e.incomingFileModal;if(s.isOpen?(r["sender-nickname"].textContent=s.senderNickname,r["incoming-file-name"].textContent=s.fileName,r["incoming-file-size"].textContent=s.fileSize,r["thumbnail-container"].innerHTML=s.thumbnail||'<i class="material-icons large-icon">description</i>',r.modalInstance.show()):r.modalInstance.hide(),e.toast.isShown){let t,o;switch(e.toast.type){case"success":t="check_circle",o="bg-success";break;case"error":t="error",o="bg-danger";break;case"info":default:t="info",o="bg-primary";break}const a=`
      <div class="toast custom-toast align-items-center text-white ${o} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex align-items-center">
          <i class="material-icons toast-icon">${t}</i>
          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;r["toast-container"].innerHTML=a}else r["toast-container"].innerHTML="";r["developer-info"].textContent="Developed by Initial H",r["app-version"].textContent="2.0.0"}function Q(){Z(),D(G),r["theme-toggle"].addEventListener("change",e=>{O(e.target.checked?"dark":"light")}),r["file-input"].addEventListener("change",e=>{const n=e.target.getAttribute("data-target-id"),s=e.target.files;n&&s.length>0&&J(n,s),e.target.value=""}),r["my-nickname"].addEventListener("click",()=>{const e=u().myNickname,n=prompt("Enter your new nickname:",e);n&&n.trim()!==e&&V(n.trim())}),r["accept-file-button"].addEventListener("click",()=>{const{onAccept:e}=u().incomingFileModal;typeof e=="function"&&e()}),r["reject-file-button"].addEventListener("click",()=>{const{onReject:e}=u().incomingFileModal;typeof e=="function"&&e()}),r["cancel-transfer-button"].addEventListener("click",()=>{const{cancelTransfer:e}=u();typeof e=="function"&&e()})}document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("theme")||"light";O(e),Q(),R()});
